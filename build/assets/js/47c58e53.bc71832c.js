"use strict";(self.webpackChunkwlx_docs=self.webpackChunkwlx_docs||[]).push([[6196],{9740:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>c});var i=s(7624),a=s(2172);const t={draft:!1,sidebar_position:3},l="Asteroids",o={id:"WLX/examples/asteroids",title:"Asteroids",description:"A multiplayer game with projectiles and primitive enemies. This is an extreme case of Dynamic symbols usage. All particles are calculated on server and then, broadcasted every 1/30 sec. for all connected clients.",source:"@site/docs/WLX/examples/asteroids.md",sourceDirName:"WLX/examples",slug:"/WLX/examples/asteroids",permalink:"/wlx-docs/docs/WLX/examples/asteroids",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedAt:1708366829,formattedLastUpdatedAt:"Feb 19, 2024",sidebarPosition:3,frontMatter:{draft:!1,sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Bouncing balls",permalink:"/wlx-docs/docs/WLX/examples/app"},next:{title:"Todo list",permalink:"/wlx-docs/docs/WLX/examples/todolist"}},r={},c=[{value:"App instances",id:"app-instances",level:2},{value:"Limitations of graphical output",id:"limitations-of-graphical-output",level:3},{value:"Server&#39;s cycle",id:"servers-cycle",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",strong:"strong",...(0,a.M)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"asteroids",children:"Asteroids"}),"\n",(0,i.jsxs)(n.p,{children:["A ",(0,i.jsx)(n.strong,{children:"multiplayer game"})," with projectiles and primitive enemies. This is an extreme case of ",(0,i.jsx)(n.a,{href:"/wlx-docs/docs/WLX/dynamics#Dynamic%20symbols",children:"Dynamic symbols"})," usage. All particles are calculated on server and then, broadcasted every ",(0,i.jsx)(n.code,{children:"1/30"})," sec. for all connected clients."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:s(7704).c+"",width:"600",height:"393"})}),"\n",(0,i.jsx)(n.p,{children:"To run this demo"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/JerryI/wl-wlx\ncd wl-wlx\nwolframscript -f Examples/Asteroids/Asteroids.wls\n"})}),"\n",(0,i.jsxs)(n.p,{children:["All players connection are managed by events system and a global event object ",(0,i.jsx)(n.code,{children:'"game"'})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-mathematica",children:'players = <||>;\nEventHandler["game", {\n   "Add player" -> Function[data,\n      Echo["Add player from socket"];\n      With[{cli = data["Client"]},\n         players[cli] = data;\n      ]\n   ],\n\n   "Remove player" -> Function[data,\n      Echo["Remove player"];\n      With[{cli = data["Client"]},\n         players[cli] = .;\n      ]\n   ],\n\n   _ -> Null\n}];\n'})}),"\n",(0,i.jsx)(n.h2,{id:"app-instances",children:"App instances"}),"\n",(0,i.jsx)(n.p,{children:"For each window a separate instance of app is generated"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",children:'App[OptionsPattern[]] := With[{\n   globalControls = OptionValue["Controls"],\n   localControls  = CreateUUID[]\n},\n   With[{\n      PlottingDevice = create[globalControls]\n   },\n\n      <div class="divide-y divide-gray-200 max-w-lg overflow-hidden rounded-lg bg-white shadow">\n        <div class="px-2 py-2">\n         <WLJS>\n            <PlottingDevice/> \n         </WLJS>\n        </div>\n      </div>\n   ]\n]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["where ",(0,i.jsx)(n.code,{children:"create"})," allocates symbols for players targets, life meter and etc..."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-mathematica",children:'create[controls_] := Module[{\n   target = {0,-1},\n   life = 2.,\n   score = 0,\n   listener,\n   enemies = {},\n   projectiles = {},\n   positions = {},\n   gameEvents,\n   delay = 5\n},\n\n   gameEvents = EventClone["game"];\n   EventHandler[controls, {\n      "Destroy" -> Function[cli,\n         Echo["Widget removed!"];\n         EventFire["game", "Remove player", <|"Client"->cli|>];\n         EventRemove[gameEvents];\n         checkTask;\n      ],\n\n      "Connected" -> Function[cli,\n         EventHandler[gameEvents, {\n            UpdatePositions -> Function[Null,\n               positions = #["Target"] &/@ Values[players];\n            ],\n\n            UpdateProjectiles -> Function[Null,\n               projectiles = proximitySort[projectiles, #[[1]] &/@ globalProjectiles];\n            ],\n\n            UpdateEnemies -> Function[Null,\n               enemies = proximitySort[enemies, #[[1]] &/@ globalEnemies];\n               If[life < 0, \n                  Close[cli];\n               ];\n            ]\n         }];\n\n         EventFire["game", "Add player", <|"Client"->cli, "Target":>target, "Life":>life|>];\n         checkTask;\n      ]\n   }]; \n\n\n   listener = {White, EventHandler[Rectangle[{-10, -10}, {10,10}], {\n      "mousemove"->Function[xy, \n         target = xy;\n         EventFire["game", UpdatePositions, Null];\n         delay -= 1;\n         If[delay < 0,\n            globalProjectiles = Append[globalProjectiles,  Projectile[xy + {0, 0.05}, {RandomReal[{-0.03,0.03}], 0.15}, 2]];\n            delay = 4;\n         ];\n      ]\n   }]};\n\n\n\n   Graphics[{\n      listener, \n      {Green, Rectangle[{1,-1}, {1.1, Offload[life] - 1}]},\n      {Blue, PointSize[0.1], Point @ Offload @ enemies},\n      RGBColor[1.0 - 0.1764, 1.0 - 0.8313, 1.0 - 0.74901], Point[Offload @ projectiles],\n      RGBColor[0.1764, 0.8313, 0.74901], PointSize[0.05], Point[Offload @ positions]\n   }, TransitionDuration->1, TransitionType->"Linear", PlotRange->{{-1,1}, {-1,1}}]\n];\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Players position is stored in ",(0,i.jsx)(n.code,{children:"target"})," symbol, which is shared with a global variable ",(0,i.jsx)(n.code,{children:"players"})," using global event ",(0,i.jsx)(n.code,{children:'"New player"'}),". On every change a global event with a topic (or pattern) ",(0,i.jsx)(n.code,{children:"UpdatePositions"})," is fired, that forces all connected player to reload the positions of all connected players. The current client is also subscribed to the same global event."]}),"\n",(0,i.jsxs)(n.p,{children:["For depicting enemies, projectiles and all players ",(0,i.jsx)(n.a,{href:"/wlx-docs/docs/WLX/dynamics#Dynamic%20symbols",children:"Dynamic symbols"})," are used. However, there is a limitation, that for one symbol only one subscribed client is allowed. Therefore, for each client a local symbols such as ",(0,i.jsx)(n.code,{children:"enemies"}),", ",(0,i.jsx)(n.code,{children:"projectiles"})," and ",(0,i.jsx)(n.code,{children:"positions"})," are allocated, to which all data is transferred once an update has been fired."]}),"\n",(0,i.jsx)(n.h3,{id:"limitations-of-graphical-output",children:"Limitations of graphical output"}),"\n",(0,i.jsx)(n.p,{children:"There is a limitation in this implementation, that all local symbols for moving objects are arrays and are plotted in a very primitive way as"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-mathematica",children:"{Blue, PointSize[0.1], Point @ Offload @ enemies},...\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Since ",(0,i.jsx)(n.code,{children:"enemies"})," length is a variable, it can extend and shrink its size based on number of alive enemies. This leads to a problem, that graphics library draw them as SVG objects. Then when a new enemy added or removed, it does not know, which one is which and just adds or removes the last one, while the all previous are considered to be the same with a new position read from a new array. It leads to serious problems if interpolation is used, i.e. when order of enemies is shifted in an array, all SVG objects jump and flicker. This is a reason, why ",(0,i.jsx)(n.code,{children:"TransitionDuration"})," is set to 1, to get rid of interpolation mostly."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"A better approach"})," would be to threat them as individual graphics object on server as well. And dynamically add or remove them from the screen. ",(0,i.jsx)(n.strong,{children:"So far this feature is still in development"}),", but on can still use available methods of such as ",(0,i.jsx)(n.a,{href:"/wlx-docs/docs/WLX/dynamics#Call%20actions%20on%20a%20page",children:"Call actions on a page"})," to assign Javascript function to it."]}),"\n",(0,i.jsx)(n.h2,{id:"servers-cycle",children:"Server's cycle"}),"\n",(0,i.jsx)(n.p,{children:"Here is is rather simple, there is a single continuous async task running in the background"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-mathematica",children:"calculate := (\n   time += 0.1;\n   calculateProjectile[];\n   calculateEnemies[];\n   spawnEnemies[];\n)\n"})}),"\n",(0,i.jsx)(n.p,{children:"for each calculation cycle it fires a global event"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-mathematica",children:'globalEnemies = {};\ncalculateEnemies[] := With[{},\n   globalEnemies = calculateEnemies /@ globalEnemies;\n   EventFire["game", UpdateEnemies, Null];\n]\n'})})]})}function h(e={}){const{wrapper:n}={...(0,a.M)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},7704:(e,n,s)=>{s.d(n,{c:()=>i});const i=s.p+"assets/images/Asteroids1-ezgif.com-optimize-b468eabc7d3e50c7dce740098182b4b6.gif"},2172:(e,n,s)=>{s.d(n,{I:()=>o,M:()=>l});var i=s(1504);const a={},t=i.createContext(a);function l(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);